<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VR Library â€” Community Encyclopedia</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --paper:#FFF7EA; --ink:#2b2b2b; --muted:#6b645b; --accent:#7a4b1c; --accent-2:#b77b3d; --glass:rgba(255,255,255,0.65);
  --card-shadow: 0 6px 30px rgba(43,43,43,0.12);
  --radius:12px;
  --bg: linear-gradient(180deg,#efe7d3 0%, #f9f6f1 100%);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased}
.container{max-width:1150px; margin:28px auto; padding:0 20px}
.header{display:flex; align-items:center; gap:18px; background:var(--paper); padding:14px 18px; border-radius:16px; box-shadow:var(--card-shadow); border:1px solid rgba(122,75,28,0.06); position:sticky; top:12px; z-index:1000; backdrop-filter: blur(6px)}
.brand{display:flex; align-items:baseline; gap:12px}
.logo-title{font-family:'Merriweather', serif; font-size:20px; font-weight:700; color:var(--accent)}
.logo-sub{font-size:12px; color:var(--muted)}
.searchbar{flex:1; position:relative}
.input{width:100%; padding:10px 14px; border-radius:12px; border:1px solid rgba(43,43,43,0.06); background:var(--glass); box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); font-size:14px}
.header-actions{display:flex; gap:10px; align-items:center}
.btn{background:linear-gradient(180deg,var(--accent) 0%, var(--accent-2) 100%); color:white; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; box-shadow:0 6px 20px rgba(183,123,61,0.15)}
.linkish{background:transparent; border:1px solid rgba(0,0,0,0.06); padding:8px 10px; border-radius:8px; cursor:pointer}
.role-pill{padding:6px 8px; border-radius:8px; background:#f1e6d8; color:var(--accent); font-weight:600; font-size:13px}
.layout{display:grid; grid-template-columns:260px 1fr 300px; gap:20px; margin-top:20px}
.sidebar{background:rgba(255,255,255,0.7); padding:16px; border-radius:14px; border:1px solid rgba(43,43,43,0.03); box-shadow:0 8px 30px rgba(43,43,43,0.06)}
.h3{font-family:'Merriweather', serif; margin:0 0 10px 0}
.topic-list a{display:block; padding:8px 6px; color:var(--accent); text-decoration:none; border-radius:8px}
.topic-list a:hover{background:rgba(122,75,28,0.06)}
.filter-row{display:flex; gap:8px; flex-wrap:wrap}
.filter-chip{padding:8px 10px; border-radius:999px; background:transparent; border:1px solid rgba(43,43,43,0.06); cursor:pointer}
.feed{padding:16px; border-radius:14px; background:rgba(255,255,255,0.85); border:1px solid rgba(43,43,43,0.03); box-shadow:0 10px 30px rgba(43,43,43,0.04); min-height:60vh}
.post{display:flex; gap:14px; padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(249,246,241,0.92)); border:1px solid rgba(43,43,43,0.04); margin-bottom:12px; transition:transform .25s cubic-bezier(.2,.9,.3,1), box-shadow .25s}
.post:hover{transform:translateY(-6px); box-shadow:0 18px 40px rgba(43,43,43,0.08)}
.avatar{width:56px; height:56px; border-radius:10px; background:linear-gradient(180deg,#fff,#f4efe5); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--accent)}
.post-body{flex:1}
.post-title{font-family:'Merriweather', serif; font-size:18px; margin:0 0 6px 0}
.post-meta{color:var(--muted); font-size:13px; margin-bottom:8px}
.post-content{color:#333; margin-bottom:10px}
.tags{display:flex; gap:8px; flex-wrap:wrap}
.tag{font-size:12px; padding:6px 8px; background:#f1e6d8; color:var(--accent); border-radius:8px}
.post-actions{display:flex; gap:8px; align-items:center}
.small{padding:6px 8px; border-radius:8px; background:transparent; border:1px solid rgba(43,43,43,0.05); cursor:pointer}
.rightcol{background:rgba(255,255,255,0.7); padding:16px; border-radius:14px}
.modal-backdrop{position:fixed; inset:0; display:none; background:rgba(9,8,6,0.45); align-items:center; justify-content:center; z-index:2000}
.modal{width:820px; max-width:94%; background:var(--paper); border-radius:14px; padding:18px; box-shadow:0 30px 60px rgba(0,0,0,0.4); transform:scale(.98); opacity:0; transition:all .28s cubic-bezier(.2,.9,.3,1); max-height:92vh; overflow:auto}
.modal.show{transform:scale(1); opacity:1}
.form-row{display:flex; gap:10px}
.input-md{width:100%; padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06)}
.textarea-md{width:100%; min-height:160px; padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); resize:vertical}
.fade-in{animation:fadeIn .45s ease forwards}
@keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
@media (max-width:1000px){ .layout{grid-template-columns:1fr; } .rightcol{order:3} .sidebar{order:2} .header{top:0; border-radius:0; margin:0 -20px 0 -20px}}
.center{display:flex; align-items:center; gap:10px}
.muted{color:var(--muted)}
.kicker{font-size:13px; color:var(--muted); margin-bottom:8px}
.skeleton{background:linear-gradient(90deg,#efe7d3 0%, #f9f6f1 50%, #efe7d3 100%); background-size:200% 100%; animation:skele 1.4s linear infinite; border-radius:10px}
.skele-line{height:12px; margin-bottom:8px}
.skele-avatar{width:56px; height:56px; border-radius:10px}
@keyframes skele{0%{background-position:200% 0}100%{background-position:-200% 0}}
.post-snippet{color:#444; max-height:4.6em; overflow:hidden}
.filter-active{background:linear-gradient(180deg,var(--accent) 0%, var(--accent-2) 100%); color:white; border-color:transparent}
.badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#fff3e6;border:1px solid rgba(122,75,28,0.06); font-size:12px;color:var(--accent);margin-left:6px}
.actions-row{display:flex; gap:8px; align-items:center; margin-top:12px}

/* small profile modal */
.profile-mini{display:flex; gap:12px; align-items:center}
.profile-avatar{width:64px;height:64px;border-radius:12px;background:#fff;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);}

/* dark mode */
body.dark{
  --paper:#1b1b1b; --ink:#eaeaea; --muted:#bdb6a8; --accent:#e5b07b; --accent-2:#f2cfa0;
  --bg: linear-gradient(180deg,#0f0f0f 0%, #141414 100%);
}
body.dark .post{background:linear-gradient(180deg, rgba(28,28,28,0.9), rgba(22,22,22,0.95)); border-color:rgba(255,255,255,0.03)}
body.dark .sidebar, body.dark .rightcol{background:rgba(22,22,22,0.6)}
body.dark .input{background:rgba(255,255,255,0.03); border-color:rgba(255,255,255,0.04)}
body.dark .tag{background:rgba(255,255,255,0.03); color:var(--accent)}
</style>
</head>
<body>

<div class="container">
  <header class="header" role="banner">
    <div class="brand">
      <div class="logo-title">The VR Library</div>
      <div class="logo-sub">A community encyclopedia â€” elegant & persistent</div>
    </div>

    <div class="searchbar" style="max-width:680px">
      <input id="globalSearch" class="input" placeholder="Search titles, tags, and content..." aria-label="Search">
    </div>

    <div class="header-actions">
      <button id="themeToggle" class="linkish" title="Toggle dark mode">ðŸŒ—</button>
      <div id="userInfo" class="center">
        <span id="userName" class="muted"></span>
      </div>
      <button id="authBtn" class="btn">Sign in with Google</button>
      <button id="newPostBtn" class="linkish">New Post</button>
    </div>
  </header>

  <div class="layout" role="main">
    <aside class="sidebar" aria-label="Collections & Filters">
      <h3 class="h3">Collections</h3>
      <div class="topic-list" id="topicList">
        <div class="kicker muted">Loading topicsâ€¦</div>
      </div>
      <div style="height:12px"></div>
      <h3 class="h3">Filters</h3>
      <div class="filter-row" id="filterRow">
        <button class="filter-chip filter-active" data-filter="all">All</button>
      </div>
      <div style="height:12px"></div>
      <h3 class="h3">Administration</h3>
      <div id="adminPanel"><div class="muted">Sign in to see admin options</div></div>
    </aside>

    <main class="feed" id="feed" aria-live="polite">
      <div id="postsContainer">
        <!-- skeletons while loading -->
        <div style="display:flex; gap:12px; margin-bottom:12px; align-items:center">
          <div class="skeleton skele-avatar"></div>
          <div style="flex:1">
            <div class="skeleton skele-line" style="width:40%"></div>
            <div class="skeleton skele-line" style="width:80%"></div>
            <div class="skeleton skele-line" style="width:60%"></div>
          </div>
        </div>
      </div>
    </main>

    <aside class="rightcol" aria-label="Trending tags and about">
      <h3 class="h3">Trending tags <span id="trendingCount" class="badge"></span></h3>
      <div id="trending" class="kicker muted">Loading...</div>
      <div style="height:18px"></div>
      <h3 class="h3">About</h3>
      <p class="muted">All posts are stored in Firestore. Moderators and admins can manage content. Posts accept Markdown and sanitized HTML.</p>
    </aside>
  </div>
</div>

<!-- Post creation / edit modal -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="postModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h2 id="modalTitle">Create new post</h2>
    <div style="height:8px"></div>
    <div class="form-row">
      <input id="postTitle" class="input-md" placeholder="Title (required)">
      <select id="postCategory" class="input-md" aria-label="Category">
        <option value="General">General</option>
        <option value="VR Science">VR Science</option>
        <option value="History">History</option>
        <option value="Art">Art</option>
      </select>
    </div>
    <div style="height:8px"></div>
    <textarea id="postContent" class="textarea-md" placeholder="Write your article or note â€” Markdown allowed (HTML will be sanitized)"></textarea>
    <div style="height:8px"></div>
    <input id="postTags" class="input-md" placeholder="Tags (comma separated)">
    <div style="height:12px"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px">
      <button id="cancelPost" class="linkish">Cancel</button>
      <button id="submitPost" class="btn">Publish</button>
    </div>
  </div>
</div>

<!-- Read-only post viewer -->
<div class="modal-backdrop" id="viewerBackdrop" aria-hidden="true">
  <div class="modal" id="viewerModal" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <h2 id="viewerTitle"></h2>
        <div id="viewerMeta" class="kicker muted"></div>
      </div>
      <div id="viewerActions"></div>
    </div>
    <hr style="border:none; height:1px; background:#eee; margin:12px 0">
    <div id="viewerBody" class="post-content"></div>
    <div style="height:12px"></div>
    <div id="viewerTags" class="tags"></div>
  </div>
</div>

<!-- Profile modal -->
<div class="modal-backdrop" id="profileBackdrop" aria-hidden="true">
  <div class="modal" id="profileModal" role="dialog" aria-modal="true">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div class="profile-mini">
        <div class="profile-avatar" id="profileAvatar">A</div>
        <div>
          <h3 id="profileName"></h3>
          <div class="kicker muted" id="profileEmail"></div>
        </div>
      </div>
      <div id="profileActions"></div>
    </div>
    <hr style="border:none; height:1px; background:#eee; margin:12px 0">
    <div id="profileBio" class="muted">No bio</div>
  </div>
</div>


<script type="module">
  // -------------------------------
  // Firebase imports (no duplicates)
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // External libraries (working CDNs)
  import { marked } from 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
  import DOMPurify from 'https://cdn.jsdelivr.net/npm/dompurify@2.4.3/dist/purify.min.js';

  // -------------------------------
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBWlj0gA31boKWZ8Rukj7oSUZbIqUsY6Sk",
    authDomain: "tipidi-tapap.firebaseapp.com",
    projectId: "tipidi-tapap",
    storageBucket: "tipidi-tapap.firebasestorage.app",
    messagingSenderId: "607716485574",
    appId: "1:607716485574:web:52a976161569ac79a06ac7",
    measurementId: "G-WJNZNZ4Q9Q"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // -------------------------------
  // Google Sign-In
  window.googleLogin = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const roleDoc = await getDoc(doc(db, 'roles', user.uid));
      if (!roleDoc.exists()) {
        await setDoc(doc(db, 'roles', user.uid), { role: 'user' });
      }
    } catch (err) {
      alert('Sign-in failed: ' + err.message);
    }
  };

  window.googleLogout = async () => { await signOut(auth); };

  onAuthStateChanged(auth, user => {
    window.currentUser = user;
    const userNameEl = document.getElementById('userName');
    const signInBtn = document.getElementById('signInBtn');

    if(user){
      userNameEl.textContent = user.displayName;
      signInBtn.style.display = 'none';
    } else {
      userNameEl.textContent = '';
      signInBtn.style.display = 'inline-block';
    }
  });

  // -------------------------------
  // Modal logic
  const modalBackdrop = document.getElementById('modalBackdrop');
  const postModal = document.getElementById('postModal');

  document.getElementById('newPostBtn').addEventListener('click', () => {
    if(!window.currentUser){ alert('Sign in first'); return; }
    modalBackdrop.style.display = 'flex';
    setTimeout(() => postModal.classList.add('show'), 10);
  });

  document.getElementById('cancelPost').addEventListener('click', () => {
    postModal.classList.remove('show');
    setTimeout(() => modalBackdrop.style.display = 'none', 250);
  });

  // -------------------------------
  // Submit new post
  document.getElementById('submitPost').addEventListener('click', async () => {
    const title = document.getElementById('postTitle').value.trim();
    const content = document.getElementById('postContent').value.trim();
    if(!title || !content){ alert('Title and content required'); return; }

    const tags = document.getElementById('postTags').value.split(',').map(s=>s.trim()).filter(Boolean);
    const category = document.getElementById('postCategory').value;

    await addDoc(collection(db, 'posts'), {
      title,
      content,
      tags,
      category,
      author: { uid: window.currentUser.uid, name: window.currentUser.displayName },
      createdAt: serverTimestamp(),
      visible: true
    });

    // Clear form
    document.getElementById('postTitle').value = '';
    document.getElementById('postContent').value = '';
    document.getElementById('postTags').value = '';
    document.getElementById('postCategory').value = 'General';

    postModal.classList.remove('show');
    setTimeout(() => modalBackdrop.style.display = 'none', 250);
  });

  // -------------------------------
  // Load posts from Firestore
  const postsQuery = query(collection(db,'posts'), orderBy('createdAt','desc'));
  onSnapshot(postsQuery, snap => {
    const container = document.getElementById('postsContainer');
    container.innerHTML = '';

    snap.forEach(docSnap => {
      const p = docSnap.data();
      if(!p.visible) return;

      const el = document.createElement('div');
      el.className = 'post';

      // Markdown to safe HTML
      const safeContent = DOMPurify.sanitize(marked.parse(p.content));

      el.innerHTML = `
        <div class="avatar">${p.author?.name[0]||'A'}</div>
        <div class="post-body">
          <h3 class="post-title">${p.title}</h3>
          <p class="post-content">${safeContent}</p>
          <small class="post-meta">By ${p.author.name}</small>
        </div>
      `;

      container.appendChild(el);
    });
  });
</script>


</body>
</html>
